name: Update Docker Hub Overview

on:
  push:
    branches:
      - main
    paths:
      - 'README.md'
      - '.github/workflows/update-dockerhub.yml'
  workflow_dispatch:

jobs:
  update-dockerhub:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up environment variables
        run: |
          echo "DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}" >> $GITHUB_ENV
          echo "DOCKERHUB_REPOSITORY=spamassassin-mcp" >> $GITHUB_ENV
          echo "GITHUB_REPOSITORY_OWNER=${{ github.repository_owner }}" >> $GITHUB_ENV

      - name: Generate Docker Hub overview
        run: |
          # Extract description from README.md
          DESCRIPTION=$(head -n 3 README.md | tail -n 1)
          
          # Extract key features
          FEATURES=$(sed -n '/## 🛡️ Security-First Design/,/## 🚀 Quick Start/p' README.md | head -n -1)
          
          # Extract quick start guide
          QUICK_START=$(sed -n '/### 1. Alternative: Use Pre-built Image/,/### 2. Connect Claude Code/p' README.md | head -n -3)
          
          # Extract configuration
          CONFIG=$(sed -n '/### Environment Variables/,/### Security Settings/p' README.md | head -n -1)
          
          # Extract tools
          TOOLS=$(sed -n '/## 🔧 Available Tools/,/## 📁 Project Structure/p' README.md | head -n -1)
          
          # Extract health monitoring
          HEALTH=$(sed -n '/## 🏥 Health Monitoring/,/## 🔒 Security Considerations/p' README.md | head -n -1)
          
          # Create Docker Hub overview
          cat > dockerhub-overview.md << EOF
          # SpamAssassin MCP Server
          
          $DESCRIPTION
          
          $FEATURES
          
          ## 🚀 Quick Start
          
          $QUICK_START
          
          ## 🛠️ Configuration
          
          $CONFIG
          
          ## 📋 Available Tools
          
          $TOOLS
          
          ## 🏥 Health Monitoring
          
          $HEALTH
          
          ## 📚 Documentation
          
          For detailed documentation, please visit:
          - [GitHub Repository](https://github.com/$GITHUB_REPOSITORY_OWNER/spamassassin-mcp)
          - [API Reference](https://github.com/$GITHUB_REPOSITORY_OWNER/spamassassin-mcp/blob/main/docs/API.md)
          - [Configuration Guide](https://github.com/$GITHUB_REPOSITORY_OWNER/spamassassin-mcp/blob/main/docs/CONFIGURATION.md)
          - [Security Guide](https://github.com/$GITHUB_REPOSITORY_OWNER/spamassassin-mcp/blob/main/docs/SECURITY.md)
          
          ## 📄 License
          
          MIT License - See [LICENSE](https://github.com/$GITHUB_REPOSITORY_OWNER/spamassassin-mcp/blob/main/LICENSE) file for details.
          EOF
          
          # Replace placeholders
          sed -i "s/your-dockerhub-username/$DOCKERHUB_USERNAME/g" dockerhub-overview.md
          sed -i "s/your-username/$GITHUB_REPOSITORY_OWNER/g" dockerhub-overview.md

      - name: Update Docker Hub description
        if: env.DOCKERHUB_USERNAME != ''
        uses: peter-evans/dockerhub-description@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
          repository: ${{ secrets.DOCKERHUB_USERNAME }}/spamassassin-mcp
          short-description: "A secure, containerized Model Context Protocol (MCP) server that integrates SpamAssassin for defensive email security analysis."
          readme-filepath: ./dockerhub-overview.md